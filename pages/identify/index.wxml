<!-- 病虫害识别页面 -->
<view class="container">
  <view class="header">
    <text class="title">病虫害识别</text>
  </view>
  
  <view class="content">
    <!-- 相机/图片预览区域 -->
    <view class="camera-area">
      <!-- 无图片状态 -->
      <text wx:if="{{!imageTempPath && !showResult}}">点击下方按钮拍照或上传图片</text>
      
      <!-- 图片预览 -->
      <image 
        wx:if="{{imageTempPath && !showResult}}" 
        src="{{imageTempPath}}" 
        mode="aspectFill"
        class="preview-image"
      ></image>
    </view>
    
    <!-- 操作按钮组 -->
    <view class="action-buttons" wx:if="{{!showResult}}">
      <button bindtap="takePhoto" disabled="{{loading}}">拍照识别</button>
      <button bindtap="chooseImage" disabled="{{loading}}">从相册选择</button>
    </view>
    
    <!-- 状态提示 -->
    <text class="status-text" wx:if="{{!loading && !imageTempPath && !showResult && !taskId}}">准备就绪，点击按钮开始识别</text>
    
    <!-- 任务状态显示 -->
    <view class="task-status-card" wx:if="{{taskId}}">
      <view class="status-header">
        <text class="status-label">任务状态</text>
        <text class="status-value status-{{taskStatus || 'pending'}}">{{taskStatusText || '等待识别'}}</text>
      </view>
      <view class="status-meta">
        <text wx:if="{{lastUpdatedAt}}">最近更新：{{lastUpdatedAt}}</text>
        <text wx:if="{{taskData && taskData.description}}" class="status-desc">备注：{{taskData.description}}</text>
      </view>
      <view class="status-progress" wx:if="{{taskStatus !== 'completed' && taskStatus !== 'failed'}}">
        <view class="loading-spinner"></view>
        <text class="status-text">AI 正在识别中，请稍候...</text>
      </view>
      <view class="status-progress failed" wx:if="{{taskStatus === 'failed'}}">
        <text class="status-icon">❌</text>
        <text class="status-text">{{taskData && taskData.error_message ? taskData.error_message : '识别失败，请重试'}}</text>
        <button bindtap="reIdentify" type="primary" size="mini" style="margin-top: 20rpx;">重新识别</button>
      </view>
      <image 
        wx:if="{{(taskData && taskData.file_url) && !showResult}}" 
        src="{{taskData.file_url}}" 
        mode="aspectFill"
        class="preview-image slim"
      ></image>
    </view>
    
    <!-- 识别结果展示区域 -->
    <view class="result-container" wx:if="{{showResult}}">
      <view class="result-title">识别结果</view>
      
      <!-- 显示上传的图片 -->
      <image 
        wx:if="{{imageTempPath}}" 
        src="{{imageTempPath}}" 
        mode="aspectFill"
        class="result-image"
      ></image>
      
      <view class="result-content">
        <view class="result-item" wx:if="{{resultSummary}}">
          <text class="label">识别结论：</text>
          <text class="value">{{resultSummary}}</text>
        </view>
        
        <view class="result-item" wx:if="{{resultConfidenceText}}">
          <text class="label">置信度：</text>
          <text class="value">{{resultConfidenceText}}</text>
        </view>
        
        <view class="result-item" wx:if="{{taskId}}">
          <text class="label">任务编号：</text>
          <text class="value">{{taskId}}</text>
        </view>
        
        <view class="chip-list" wx:if="{{resultLabels.length}}">
          <text class="chip" wx:for="{{resultLabels}}" wx:key="*this">{{item}}</text>
        </view>
        
        <view class="result-section" wx:if="{{resultSuggestions.length}}">
          <text class="section-title">处理建议</text>
          <view class="bullet-line" wx:for="{{resultSuggestions}}" wx:key="*this">
            <text class="bullet">•</text>
            <text class="description">{{item}}</text>
          </view>
        </view>
        
        <view class="result-section" wx:if="{{resultExtraPairs.length}}">
          <text class="section-title">更多信息</text>
          <view class="kv-row" wx:for="{{resultExtraPairs}}" wx:key="key">
            <text class="kv-key">{{item.key}}</text>
            <text class="kv-value">{{item.value}}</text>
          </view>
        </view>
        
        <view class="result-section" wx:if="{{formattedResultJson}}">
          <text class="section-title">原始结果</text>
          <text class="json-block">{{formattedResultJson}}</text>
        </view>
      </view>
      
      <!-- 结果操作按钮 -->
      <view class="result-actions">
        <button bindtap="saveResult" type="primary">保存结果</button>
        <button bindtap="viewDiseaseDetail" type="default">查看详情</button>
        <button bindtap="reIdentify" type="warn">重新识别</button>
      </view>
    </view>
  </view>
</view>