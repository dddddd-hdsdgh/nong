# 农业病虫害识别微信小程序 - 数据库设计文档

## 设计概述

本文档详细描述了农业病虫害识别微信小程序的数据库表结构设计。该设计基于对项目功能模块的全面分析，包括用户系统、论坛互动、病虫害识别、知识库等核心功能。数据库采用关系型设计，使用Supabase作为后端服务，支持实时数据同步和灵活的权限控制。

## 核心表结构

### 1. 用户相关表

#### users（用户表）
- **功能**: 存储用户基本信息和身份数据
- **主要字段**:
  - `id`: 用户唯一标识
  - `open_id`: 微信openid
  - `username`: 用户名
  - `avatar_url`: 头像URL
  - `identity`: 用户身份（农户/专家）
  - `location`: 地区信息
  - `level`: 用户等级

#### user_follows（用户关注关系表）
- **功能**: 管理用户间的关注关系
- **主要字段**:
  - `follower_id`: 关注者ID
  - `followed_id`: 被关注者ID

#### user_favorites（用户收藏表）
- **功能**: 统一管理用户对不同类型内容的收藏
- **主要字段**:
  - `user_id`: 用户ID
  - `content_id`: 内容ID
  - `type`: 内容类型（如knowledge、post等）

### 2. 论坛相关表

#### forum_posts（论坛帖子表）
- **功能**: 存储论坛帖子内容和元数据
- **主要字段**:
  - `user_id`: 作者ID
  - `title`: 帖子标题
  - `content`: 帖子内容
  - `category`: 分类
  - `sub_category`: 子分类
  - `images`: 图片数组
  - `likes_count`: 点赞数
  - `comments_count`: 评论数
  - `views_count`: 浏览数
  - `hot_score`: 热度分数

#### forum_comments（论坛评论表）
- **功能**: 存储帖子评论数据
- **主要字段**:
  - `post_id`: 关联的帖子ID
  - `user_id`: 评论者ID
  - `content`: 评论内容
  - `reply_to`: 回复对象

#### forum_likes（帖子点赞表）
- **功能**: 记录用户对帖子的点赞行为
- **主要字段**:
  - `post_id`: 帖子ID
  - `user_id`: 用户ID

#### comment_likes（评论点赞表）
- **功能**: 记录用户对评论的点赞行为
- **主要字段**:
  - `comment_id`: 评论ID
  - `user_id`: 用户ID

#### forum_collections（帖子收藏表）
- **功能**: 记录用户对帖子的收藏行为
- **主要字段**:
  - `post_id`: 帖子ID
  - `user_id`: 用户ID

### 3. 病虫害识别相关表

#### identify_records（识别记录表）
- **功能**: 存储用户的病虫害识别历史
- **主要字段**:
  - `user_id`: 用户ID
  - `image_url`: 识别图片URL
  - `result`: 识别结果（JSON格式）
  - `confidence`: 置信度
  - `is_saved`: 是否保存

#### diseases（病虫害信息表）
- **功能**: 存储病虫害的详细信息
- **主要字段**:
  - `name`: 病虫害名称
  - `category`: 分类
  - `description`: 描述
  - `symptoms`: 症状
  - `control_methods`: 防治方法
  - `images`: 图片数组
  - `identify_count`: 识别次数

### 4. 知识库相关表

#### knowledge_categories（知识分类表）
- **功能**: 管理知识库文章分类
- **主要字段**:
  - `name`: 分类名称
  - `icon`: 分类图标
  - `sort_order`: 排序顺序

#### knowledge_articles（知识文章表）
- **功能**: 存储知识库文章内容
- **主要字段**:
  - `category_id`: 所属分类ID
  - `title`: 文章标题
  - `content`: 文章内容
  - `cover_image`: 封面图片
  - `view_count`: 浏览数
  - `like_count`: 点赞数

### 5. 通知系统

#### notifications（通知表）
- **功能**: 管理用户通知消息
- **主要字段**:
  - `user_id`: 接收用户ID
  - `type`: 通知类型
  - `title`: 通知标题
  - `content`: 通知内容
  - `related_id`: 相关业务ID
  - `is_read`: 是否已读

## 设计特点

1. **完整性**:
   - 覆盖了用户、论坛、识别、知识库四大核心功能模块
   - 支持用户交互（点赞、评论、收藏、关注）
   - 提供通知系统实现消息推送

2. **灵活性**:
   - 使用UUID作为主键，便于分布式系统扩展
   - 采用JSONB类型存储图片数组和复杂数据结构
   - 设计了通用的收藏表，支持多种内容类型

3. **性能优化**:
   - 为常用查询字段创建了索引
   - 冗余存储计数字段（点赞数、评论数等）避免频繁计算
   - 分区存储不同类型的数据，提高查询效率

4. **安全性**:
   - 实现了基于用户ID的数据隔离
   - 设计了完整的权限策略（基于Supabase RLS）
   - 敏感操作需要用户认证

## 使用说明

### Supabase配置

1. 在Supabase中创建新项目
2. 使用提供的SQL脚本创建所有表结构
3. 配置表的行级安全策略
4. 在小程序中配置Supabase客户端（services/supabase.js）

### 数据访问模式

- **用户管理**: 用户登录后获取openid，创建或更新用户记录
- **内容浏览**: 公开内容可直接查询，支持分页和排序
- **用户交互**: 点赞/收藏/评论等操作会同时更新相关计数
- **识别功能**: 图片存储在Supabase Storage，识别结果保存在identify_records表

### 扩展建议

1. 随着用户量增长，考虑为热门表添加分区
2. 可根据业务需求增加更多表，如专家问答表、活动表等
3. 建议实现定时任务，定期计算论坛帖子的热度分数

## 注意事项

1. 确保在Supabase中正确配置存储桶权限，允许图片上传和访问
2. 用户认证采用微信小程序授权登录，需要在app.json中配置权限
3. 大数据量查询应使用分页，并合理设置页面大小
4. 敏感操作（如内容发布）建议增加审核机制

---

本数据库设计基于项目当前功能需求，可根据业务发展进行调整和扩展。